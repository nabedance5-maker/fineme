<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>相性の見え方 | Fineme（掲載者向け）</title>
  <link rel="stylesheet" href="../../assets/styles/style.css" />
  <link rel="stylesheet" href="../../assets/styles/components.css" />
</head>
<body>
  <div id="provider-navbar"></div>
  <main class="section">
    <div class="container stack">
      <h1 class="section-title">Fineme内での“相性の見え方”</h1>
      <p class="muted">順位は表示せず、ゾーンで伝えます。表示されないのは「悪い」からではなく、合わない人に無理に届かない設計です。</p>
      <section id="compat-host" class="stack"></section>
    </div>
  </main>
  <div id="provider-footer"></div>
  <script src="../../scripts/partials.js" type="module"></script>
  <script type="module">
    import { requireProviderAuth } from '../../scripts/auth.js';
    const session = requireProviderAuth();
    const PROVIDERS_KEY = 'glowup:providers';
    function loadProviders(){ try{ const raw=localStorage.getItem(PROVIDERS_KEY); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[]; }catch{ return []; } }

    function classifyTypeFromScores(sc){
      try{
        const A=Number(sc.A||2),B=Number(sc.B||2),C=Number(sc.C||2),D=Number(sc.D||2),E=String((sc.E_tags||[])[0]||'');
        const ideal={
          t01:{ name:'慎重・納得重視タイプ', vec:{A:3,B:3,C:2,D:2}, bonus:['理論・根拠'] },
          t02:{ name:'安心・寄り添い重視タイプ', vec:{A:2,B:4,C:1,D:1}, bonus:['安心感'] },
          t03:{ name:'効率・最短重視タイプ', vec:{A:2,B:1,C:3,D:3}, bonus:['実績'] },
          t04:{ name:'変化・アップデート重視タイプ', vec:{A:4,B:1,C:4,D:2}, bonus:['センス'] },
          t05:{ name:'直感・フィーリング重視タイプ', vec:{A:2,B:2,C:2,D:2}, bonus:['センス'] },
          t06:{ name:'伴走・共同決定重視タイプ', vec:{A:3,B:2,C:2,D:2}, bonus:['安心感','理論・根拠'] }
        };
        const entries = Object.values(ideal).map(meta=>{ const v=meta.vec; let d=Math.abs(A-v.A)+Math.abs(B-v.B)+Math.abs(C-v.C)+Math.abs(D-v.D); if(E && meta.bonus.includes(E)) d -= 0.6; return { name:meta.name, dist:d }; });
        entries.sort((a,b)=> a.dist-b.dist);
        return entries.map(e=> e.name);
      }catch{ return []; }
    }

    function render(){
      const host = document.getElementById('compat-host'); host.textContent='';
      const me = loadProviders().find(p=> p.id===session.id) || {};
      const sc = me.onboarding?.scores || {};
      const order = classifyTypeFromScores(sc);
      if(!order.length){ const p=document.createElement('p'); p.className='muted'; p.textContent='まだスコアが設定されていません。オンボーディングから入力してください。'; host.appendChild(p); return; }
      const zones = [
        { label:'相性がいい', items: order.slice(0,1) },
        { label:'合いそう', items: order.slice(1,3) },
        { label:'表示されにくい', items: order.slice(3) }
      ];
      zones.forEach(z => {
        if(!z.items.length) return;
        const card = document.createElement('div'); card.className='card'; card.style.padding='12px';
        const h = document.createElement('strong'); h.textContent = z.label; card.appendChild(h);
        const ul = document.createElement('ul'); z.items.forEach(n=>{ const li=document.createElement('li'); li.textContent = n; ul.appendChild(li); }); card.appendChild(ul);
        host.appendChild(card);
      });
      const note = document.createElement('p'); note.className='muted'; note.textContent='表示順はゾーン内で適度に前後します。価値観タグの一致で微調整されます。'; host.appendChild(note);
    }

    // partials navbar ready → render
    try{
      if(window.finemePartials && window.finemePartials.provNavReady){ window.finemePartials.provNavReady.then(render); }
      else { document.addEventListener('fineme:provNavReady', render, { once:true }); setTimeout(render, 500); }
    }catch{ render(); }
  </script>
</body>
</html>
