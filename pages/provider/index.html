<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ²è¼‰è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | Fineme</title>
  <link rel="stylesheet" href="../../assets/styles/style.css" />
  <link rel="stylesheet" href="../../assets/styles/components.css" />
</head>
<body>
  <div id="provider-navbar"></div>
  <main class="section">
    <div class="container stack">
      <h1 class="section-title">æ²è¼‰è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p class="muted">é †ä½ã¯å‡ºã—ã¾ã›ã‚“ã€‚æ„å‘³ã§ç´å¾—ã—ã€è¡Œå‹•ã«å¤‰ã‚ã‚‹ãŸã‚ã®ç®¡ç†ç”»é¢ã§ã™ã€‚</p>
      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚µãƒãƒªãƒ¼ -->
      <section id="status-summary" class="card" style="padding:12px;">
        <strong>ã‚ãªãŸã®åº—èˆ—ã®ç¾åœ¨åœ°</strong>
        <div class="grid" style="display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px">
          <div><span class="muted">ç›¸æ€§ã‚¾ãƒ¼ãƒ³ï¼š</span> <span id="sum-zone">â€”</span></div>
          <div><span class="muted">ä»Šã€ç‰¹ã«åˆã„ã‚„ã™ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—ï¼š</span> <span id="sum-type">â€”</span></div>
          <div><span class="muted">ä»Šæœˆã®äºˆç´„æ•°ï¼š</span> <span id="sum-resv">â€”</span></div>
        </div>
      </section>
      <!-- Finemeçš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ€æƒ³UIï¼‰ -->
      <section class="card" style="padding:12px;">
        <blockquote style="margin:0 0 8px 0;">
          <p style="margin:0">Finemeã§ã¯ã€ã€ŒãŸãã•ã‚“è¦‹ã‚‰ã‚Œã‚‹ã€ã‚ˆã‚Šã€Œåˆã†äººã«å±Šãã€ã“ã¨ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚</p>
        </blockquote>
        <a class="btn btn-ghost" href="./philosophy.html">Finemeã®è€ƒãˆæ–¹ã‚’è¦‹ã‚‹</a>
      </section>
      <!-- å…¬é–‹è¨­å®šï¼ˆåº—èˆ—å…¨ä½“ï¼‰ -->
      <section id="visibility-card" class="card" style="padding:12px;">
        <div class="cluster" style="justify-content:space-between; align-items:center">
          <strong>åº—èˆ—ã®å…¬é–‹è¨­å®š</strong>
          <button id="toggle-visibility-btn" class="btn btn-ghost" type="button">èª­ã¿è¾¼ã¿ä¸­â€¦</button>
        </div>
        <p class="muted" style="margin:8px 0 0">åº—èˆ—ã‚’ã€Œéå…¬é–‹ã€ã«ã™ã‚‹ã¨ã€å€‹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ãŒå…¬é–‹è¨­å®šã§ã‚‚ã‚µã‚¤ãƒˆä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</p>
  <p class="muted" style="margin:6px 0 0; font-size:12px">â€» éå…¬é–‹è¨­å®šã§ã‚‚æœˆé¡æ–™é‡‘ã®è«‹æ±‚ã¯ç¶™ç¶šã—ã¾ã™ã€‚æœˆé¡ã‚’åœæ­¢ã—ãŸã„å ´åˆã¯ã€åˆ¥é€”ã€Œä¼‘ä¼šã€ã¾ãŸã¯ã€Œé€€ä¼šã€ã®æ‰‹ç¶šããŒå¿…è¦ã§ã™ã€‚</p>
      </section>
      <!-- æ¬¡ã®ä¸€æ‰‹ã‚¬ã‚¤ãƒ‰ï¼ˆè¡Œå‹•èª˜å°ï¼‰ -->
      <section class="card" style="padding:12px;">
        <strong>ç›¸æ€§ã‚’ã•ã‚‰ã«é«˜ã‚ã‚‹ãŸã‚ã«</strong>
        <ul class="stack" style="margin-top:8px">
          <li><label class="cluster" style="gap:8px; align-items:center"><input type="checkbox" id="todo-counsel" /> <span>ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°èª¬æ˜æ–‡ã‚’ã‚‚ã†å°‘ã—è©³ã—ã</span></label></li>
          <li><label class="cluster" style="gap:8px; align-items:center"><input type="checkbox" id="todo-target" /> <span>ã€Œã©ã‚“ãªäººã«å‘ã„ã¦ã„ã‚‹ã‹ã€ã‚’æ˜ç¢ºã«</span></label></li>
          <li><label class="cluster" style="gap:8px; align-items:center"><input type="checkbox" id="todo-bna" /> <span>Before / After ã®è€ƒãˆæ–¹ã‚’è¨€èªåŒ–</span></label></li>
        </ul>
        <div style="margin-top:8px"><a class="btn btn-ghost" href="./compatibility.html">æ”¹å–„ã™ã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ</a></div>
      </section>
      <section class="stack" style="margin-top:24px;">
        <h2 class="section-title">ãƒ¬ãƒ“ãƒ¥ãƒ¼ç®¡ç†</h2>
        <p class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ•ç¨¿ã—ãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã€è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
        <div id="provider-reviews-host" class="stack">
          <div class="cluster" style="gap:8px; align-items:center">
            <label>ãƒ•ã‚£ãƒ«ã‚¿
              <select id="prov-reviews-filter">
                <option value="all">å…¨ã¦</option>
                <option value="visible">è¡¨ç¤ºä¸­</option>
                <option value="hidden">éè¡¨ç¤º</option>
              </select>
            </label>
            <label>ã‚µãƒ¼ãƒ“ã‚¹
              <select id="prov-reviews-service">
                <option value="all">å…¨ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹</option>
              </select>
            </label>
          </div>
          <div id="prov-reviews-list" style="margin-top:12px"></div>
        </div>
      </section>
    </div>
  </main>
  <div id="provider-footer"></div>
  <script src="../../scripts/partials.js" type="module"></script>
  <script type="module">
    import { requireProviderAuth, getProviderSession, signOutProvider } from '../../scripts/auth.js';
    const PROVIDERS_KEY = 'glowup:providers';
    function loadProviders(){ try{ const raw=localStorage.getItem(PROVIDERS_KEY); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[]; }catch{ return []; } }
    import '../../scripts/provider-reviews.js';
    const session = requireProviderAuth();
    if(!session){
      // requireProviderAuth å†…ã§ãƒ­ã‚°ã‚¤ãƒ³ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™
    } else {
      // provider ãƒŠãƒ“æ³¨å…¥å®Œäº†å¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³UIã¨ã‚«ãƒ¼ãƒ‰ã‚’çµ„ã¿ç«‹ã¦ã‚‹
      const boot = () => {
        try{
          const me = loadProviders().find(p=> p.id===session.id);
          if(!me || !me.onboarding || !me.onboarding.completed){
            location.href = './onboarding.html';
            return;
          }
        }catch(_){ /* ignore */ }

        const area = document.getElementById('provider-session-area');
        if(area){
          const info = document.createElement('div');
          info.style.display='inline-flex'; info.style.gap='8px'; info.style.alignItems='center';
          info.innerHTML = `<span class="muted">${session.name} ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­</span><button class="btn btn-ghost" id="provider-logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>`;
          area.appendChild(info);
          area.addEventListener('click', (e)=>{
            const t = e.target;
            if(t && t.id === 'provider-logout-btn'){
              signOutProvider();
            }
          });
        }
        try{
          const container = document.querySelector('.container.stack');
          if(container){
            // åº—èˆ—ã®å…¬é–‹è¨­å®šãƒˆã‚°ãƒ«
            (function(){
              const card = document.getElementById('visibility-card');
              const btn = document.getElementById('toggle-visibility-btn');
              const PROVIDERS_KEY = 'glowup:providers';
              function loadProviders(){ try{ const raw=localStorage.getItem(PROVIDERS_KEY); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[]; }catch{ return []; } }
              function saveProviders(list){ try{ localStorage.setItem(PROVIDERS_KEY, JSON.stringify(list)); }catch{} }
              const list = loadProviders();
              const meIdx = list.findIndex(p=> p.id===session.id);
              if(meIdx>=0){
                const me = list[meIdx];
                me.visibility = me.visibility || 'public';
                btn.textContent = (me.visibility==='public') ? 'ç¾åœ¨: å…¬é–‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§éå…¬é–‹ï¼‰' : 'ç¾åœ¨: éå…¬é–‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å…¬é–‹ï¼‰';
                btn.addEventListener('click', ()=>{
                  try{
                    const cur = me.visibility==='public' ? 'hidden' : 'public';
                    me.visibility = cur;
                    list[meIdx] = me;
                    saveProviders(list);
                    btn.textContent = (cur==='public') ? 'ç¾åœ¨: å…¬é–‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§éå…¬é–‹ï¼‰' : 'ç¾åœ¨: éå…¬é–‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å…¬é–‹ï¼‰';
                  }catch{}
                });
                // åŠ å…¥ãƒ—ãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤º
                try{
                  const plan = me.plan || null;
                  const metaMap = {
                    p5000: { label:'5,000å††ãƒ—ãƒ©ãƒ³ï¼ˆäºˆç´„æ‰‹æ•°æ–™8ï¼…ï¼‰', price:5000, feeRate:0.08 },
                    p7000: { label:'7,000å††ãƒ—ãƒ©ãƒ³ï¼ˆäºˆç´„æ‰‹æ•°æ–™7ï¼…ï¼‰', price:7000, feeRate:0.07 },
                    p10000:{ label:'10,000å††ãƒ—ãƒ©ãƒ³ï¼ˆäºˆç´„æ‰‹æ•°æ–™6ï¼…ï¼‰', price:10000, feeRate:0.06 }
                  };
                  const meta = plan && plan.id ? (metaMap[plan.id] || { label:'æœªè¨­å®š', price:0, feeRate:0 }) : { label:'æœªè¨­å®š', price:0, feeRate:0 };
                  const planCard = document.createElement('section');
                  planCard.className = 'card';
                  planCard.style.padding='12px';
                  const head = document.createElement('div'); head.className='cluster'; head.style.justifyContent='space-between'; head.style.alignItems='center';
                  const strong = document.createElement('strong'); strong.textContent='åŠ å…¥ä¸­ã®æ²è¼‰ãƒ—ãƒ©ãƒ³'; head.appendChild(strong);
                  planCard.appendChild(head);
                  const body = document.createElement('div'); body.className='stack'; body.style.marginTop='8px';
                  const cur = document.createElement('div'); cur.innerHTML = `<span class="muted">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ï¼š</span> ${meta.label}`; body.appendChild(cur);
                  const fee = document.createElement('div'); fee.innerHTML = `<span class="muted">æœˆé¡ï¼š</span> Â¥${meta.price.toLocaleString()} ï¼ <span class="muted">äºˆç´„æ‰‹æ•°æ–™ï¼š</span> ${(Math.round(meta.feeRate*1000)/10)}%`; body.appendChild(fee);
                  const note = document.createElement('p'); note.className='muted'; note.style.margin='6px 0 0'; note.textContent='â€» ãƒ—ãƒ©ãƒ³å¤‰æ›´ã¯ç®¡ç†è€…ã«ã‚ˆã‚‹ç·¨é›†ã§è¡Œã‚ã‚Œã¾ã™ï¼ˆãƒ‡ãƒ¢ï¼‰ã€‚'; body.appendChild(note);
                  planCard.appendChild(body);
                  // visibilityã‚«ãƒ¼ãƒ‰ã®ç›´å¾Œã«æŒ¿å…¥
                  card.parentElement && card.parentElement.insertBefore(planCard, card.nextSibling);
                }catch{}
              } else {
                btn.textContent = 'è¨­å®šä¸å¯ï¼ˆåº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰'; btn.disabled = true;
              }
            })();
            // å¯è¦–åŒ–ã‚«ãƒ¼ãƒ‰ï¼šã‚¾ãƒ¼ãƒ³ï¼è¡¨ç¤ºæ©Ÿä¼šæŒ‡æ•°ï¼è·é›¢ï¼å¤‰åŒ–é‡
            const viz = document.createElement('div'); viz.className='card'; viz.style.padding='12px'; viz.style.marginTop='12px';
            const head = document.createElement('div'); head.className='cluster'; head.style.justifyContent='space-between'; head.style.alignItems='center';
            const hstrong = document.createElement('strong'); hstrong.textContent='è¡¨ç¤ºãƒã‚¸ã‚·ãƒ§ãƒ³ï¼ˆå®‰å…¨è¡¨ç¤ºï¼‰'; head.appendChild(hstrong);
            viz.appendChild(head);
            const body = document.createElement('div'); body.className='stack'; body.style.marginTop='8px';
            const idxEl = document.createElement('div'); idxEl.textContent='è¡¨ç¤ºæ©Ÿä¼šæŒ‡æ•°ï¼šâ€”'; body.appendChild(idxEl);
            const zoneEl = document.createElement('div'); zoneEl.textContent='ç¾åœ¨ã‚¾ãƒ¼ãƒ³ï¼šâ€”'; body.appendChild(zoneEl);
            const distEl = document.createElement('div'); distEl.textContent='æ¬¡ã‚¾ãƒ¼ãƒ³ã¾ã§ï¼šâ€”'; body.appendChild(distEl);
            const diffEl = document.createElement('div'); diffEl.textContent='å‰å›æ¯”ï¼šâ€”'; body.appendChild(diffEl);
            viz.appendChild(body);
            container.insertBefore(viz, container.children[1] || null);
            // ä»®ã‚¹ã‚³ã‚¢ï¼ˆMVPï¼‰ï¼šãƒ—ãƒ­ãƒ•å……å®Ÿåº¦ãƒ»æ¥åº—ç‡ãƒ»è¨ºæ–­ä¸€è‡´åº¦ã‹ã‚‰æ“¬ä¼¼åˆæˆ
            import('../../scripts/zones.js').then(zone => {
              try{
                const me = loadProviders().find(p=> p.id===session.id) || {};
                // ---- å®Ÿå€¤åŒ–: äºˆç´„/æ¥åº—MVPã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œæˆåº¦ã‚’åæ˜  ----
                const RESV_KEY = 'glowup:reservations';
                const VISIT_KEY = 'glowup:visits';
                let reservations = []; let visits = [];
                try{ const rawR=localStorage.getItem(RESV_KEY); reservations = rawR? JSON.parse(rawR):[]; }catch{}
                try{ const rawV=localStorage.getItem(VISIT_KEY); visits = rawV? JSON.parse(rawV):[]; }catch{}
                // providerå˜ä½ã§é›†è¨ˆ
                const myRes = Array.isArray(reservations)? reservations.filter(r=> r && r.providerId===session.id):[];
                const myVisits = Array.isArray(visits)? visits.filter(v=> v && v.providerId===session.id):[];
                const totalRes = myRes.length;
                const completed = myRes.filter(r=> r.status==='visited' || r.status==='completed').length;
                const repeatedUsers = (function(){
                  const map = new Map();
                  for(const v of myVisits){
                    const uid = v.userId||''; map.set(uid, (map.get(uid)||0)+1);
                  }
                  let rep=0; for(const cnt of map.values()){ if(cnt>=2) rep++; }
                  const totalUsers = map.size || 1;
                  return Math.round((rep/totalUsers)*100);
                })();
                const visitRate = totalRes? Math.round((completed/totalRes)*100) : 0; // %
                const repeatRate = repeatedUsers; // %
                const completion = Number(me.profile?.completionRate||0); // 0-100
                const trust = Math.round((visitRate * 0.5) + (repeatRate * 0.3) + (completion * 0.2));
                // è¨ºæ–­ä¸€è‡´åº¦: whatTypesã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨ºæ–­intent.type_idã®ä¸€è‡´
                let affinity = 40;
                try{
                  const raw = localStorage.getItem('fineme:diagnosis:latest');
                  const diag = raw? JSON.parse(raw): null;
                  const typeId = String(diag?.intent?.type_id||'');
                  const what = (me.onboarding?.profile?.whatTypes)||[];
                  if(typeId){
                    if(Array.isArray(what) && what.includes(typeId)) affinity = 90;
                    else if(Array.isArray(what) && what.length>0) affinity = 60;
                    else affinity = 50;
                  }
                }catch{}
                // è£œæ­£: åº—èˆ—å†™çœŸã‚„èª¬æ˜ã®å……å®Ÿåº¦ï¼ˆç°¡æ˜“ã« completion ã‚’å†ä½¿ç”¨ï¼‰
                const correction = Math.round(completion);
                // ç·åˆã‚¹ã‚³ã‚¢ï¼ˆé‡ã¿: ç›¸æ€§0.5 è£œæ­£0.3 ä¿¡é ¼0.2ï¼‰
                const Si = Math.round((affinity * 0.5) + (correction * 0.3) + (trust * 0.2));
                const Smin = 20; const Smax = 95; // ä»®å®šï¼ˆã‚¿ã‚¤ãƒ—å†…åˆ†å¸ƒï¼‰
                const prevNi = Number(localStorage.getItem('fineme:zone:lastNi')||'');
                const NiRaw = zone.normalizeScore(Si, Smin, Smax);
                const Ni = zone.smooth(Number.isFinite(prevNi)? prevNi : undefined, NiRaw, 0.3);
                localStorage.setItem('fineme:zone:lastNi', String(Ni));
                const z = zone.zoneOf(Ni);
                const dist = zone.distanceToNextZone(Ni);
                idxEl.textContent = `è¡¨ç¤ºæ©Ÿä¼šæŒ‡æ•°ï¼š${Ni} / 100`;
                zoneEl.textContent = `ç¾åœ¨ã‚¾ãƒ¼ãƒ³ï¼š${z.name}`;
                distEl.textContent = `æ¬¡ã‚¾ãƒ¼ãƒ³ã¾ã§ï¼š+${dist}pt`;
                const diff = (Number.isFinite(prevNi) ? (Ni - prevNi) : 0);
                diffEl.textContent = `å‰å›æ¯”ï¼š${diff>=0?'+':''}${diff}`;

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚µãƒãƒªãƒ¼ã®æ›´æ–°
                try{
                  const sumZone = document.getElementById('sum-zone');
                  const sumType = document.getElementById('sum-type');
                  const sumResv = document.getElementById('sum-resv');
                  if(sumZone){
                    // ã‚¾ãƒ¼ãƒ³åç§°â†’ç›¸æ€§æ–‡è¨€ã«å¤‰æ›
                    const map = { 'ä¸Šä½è¡¨ç¤ºã‚¾ãƒ¼ãƒ³':'ã¨ã¦ã‚‚ç›¸æ€§ãŒã„ã„', 'æ¨™æº–è¡¨ç¤ºã‚¾ãƒ¼ãƒ³':'ç›¸æ€§ãŒã„ã„', 'æˆé•·ä¸­ã‚¾ãƒ¼ãƒ³':'åˆã„ãã†', 'æº–å‚™ä¸­ã‚¾ãƒ¼ãƒ³':'é¸æŠè‚¢ã¨ã—ã¦è¡¨ç¤º' };
                    sumZone.textContent = `${map[z.name]||z.name}ï¼ˆ${z.name}ï¼‰`;
                  }
                  // ã‚¿ã‚¤ãƒ—æ¨å®šï¼ˆAâ€“Dï¼‹Eã‹ã‚‰è¿‘ã„ã‚¿ã‚¤ãƒ—åã‚’æ¨å®šï¼‰
                  function classifyTypeFromScores(sc){
                    try{
                      const A=Number(sc.A||2),B=Number(sc.B||2),C=Number(sc.C||2),D=Number(sc.D||2),E=String((sc.E_tags||[])[0]||'');
                      const ideal={
                        t01:{ name:'æ…é‡ãƒ»ç´å¾—é‡è¦–ã‚¿ã‚¤ãƒ—', vec:{A:3,B:3,C:2,D:2}, bonus:['ç†è«–ãƒ»æ ¹æ‹ '] },
                        t02:{ name:'å®‰å¿ƒãƒ»å¯„ã‚Šæ·»ã„é‡è¦–ã‚¿ã‚¤ãƒ—', vec:{A:2,B:4,C:1,D:1}, bonus:['å®‰å¿ƒæ„Ÿ'] },
                        t03:{ name:'åŠ¹ç‡ãƒ»æœ€çŸ­é‡è¦–ã‚¿ã‚¤ãƒ—', vec:{A:2,B:1,C:3,D:3}, bonus:['å®Ÿç¸¾'] },
                        t04:{ name:'å¤‰åŒ–ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé‡è¦–ã‚¿ã‚¤ãƒ—', vec:{A:4,B:1,C:4,D:2}, bonus:['ã‚»ãƒ³ã‚¹'] },
                        t05:{ name:'ç›´æ„Ÿãƒ»ãƒ•ã‚£ãƒ¼ãƒªãƒ³ã‚°é‡è¦–ã‚¿ã‚¤ãƒ—', vec:{A:2,B:2,C:2,D:2}, bonus:['ã‚»ãƒ³ã‚¹'] },
                        t06:{ name:'ä¼´èµ°ãƒ»å…±åŒæ±ºå®šé‡è¦–ã‚¿ã‚¤ãƒ—', vec:{A:3,B:2,C:2,D:2}, bonus:['å®‰å¿ƒæ„Ÿ','ç†è«–ãƒ»æ ¹æ‹ '] }
                      };
                      const entries = Object.values(ideal).map(meta=>{ const v=meta.vec; let d=Math.abs(A-v.A)+Math.abs(B-v.B)+Math.abs(C-v.C)+Math.abs(D-v.D); if(E && meta.bonus.includes(E)) d -= 0.6; return { name:meta.name, dist:d }; });
                      entries.sort((a,b)=> a.dist-b.dist); return entries[0]?.name || '';
                    }catch{ return ''; }
                  }
                  if(sumType){
                    const sc = (loadProviders().find(p=> p.id===session.id)?.onboarding?.scores) || {};
                    const name = classifyTypeFromScores(sc);
                    sumType.textContent = name || 'â€”';
                  }
                  if(sumResv){
                    // ä»Šæœˆã®äºˆç´„æ•°ï¼ˆæ‰¿èªæ¸ˆã¿ï¼‰ã¨å…ˆæœˆæ¯”
                    const now = new Date(); const ym = `${now.getFullYear()}-${now.getMonth()+1}`;
                    const last = new Date(now.getFullYear(), now.getMonth()-1, 1); const yml = `${last.getFullYear()}-${last.getMonth()+1}`;
                    function ymKey(d){ try{ const dd=new Date(d); return `${dd.getFullYear()}-${dd.getMonth()+1}`; }catch{ return ''; } }
                    let reservations = []; try{ const raw=localStorage.getItem('fineme:reservations:list'); reservations = raw? JSON.parse(raw): []; }catch{}
                    const mine = Array.isArray(reservations) ? reservations.filter(r=> String(r.storeId||'')===String(session.id)) : [];
                    const approvedSet = new Set(['reserved','visit_pending','visited']);
                    const cur = mine.filter(r=> approvedSet.has(String(r.status||'')) && ymKey(r.visitDate)===ym).length;
                    const prev = mine.filter(r=> approvedSet.has(String(r.status||'')) && ymKey(r.visitDate)===yml).length;
                    const diffTxt = (cur-prev>=0?'+':'') + String(cur-prev);
                    sumResv.textContent = `${cur}ä»¶ï¼ˆå…ˆæœˆæ¯” ${diffTxt}ï¼‰`;
                  }
                }catch{}
              }catch(e){ /* silent */ }
            }).catch(()=>{});
            const card = document.createElement('div'); card.className='card'; card.style.padding='12px'; card.style.marginTop='12px';
            const title = document.createElement('div'); title.className='cluster'; title.style.justifyContent='space-between'; title.style.alignItems='center';
            const strong = document.createElement('strong'); strong.textContent='ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°'; title.appendChild(strong);
            const btn = document.createElement('a'); btn.className='btn btn-ghost'; btn.href='./onboarding.html#reedit'; btn.textContent='å†ä½“é¨“ãƒ»å†ç·¨é›†'; title.appendChild(btn);
            card.appendChild(title);
            const p = document.createElement('p'); p.className='muted'; p.style.margin='8px 0 0'; p.textContent='è¨ºæ–­ã®æ€æƒ³ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›ã¯ã„ã¤ã§ã‚‚è¦‹ç›´ã›ã¾ã™ã€‚'; card.appendChild(p);
            container.insertBefore(card, container.children[1] || null);
            // ç›¸æ€§å¯è¦–åŒ–UIï¼šç›¸æ€§ãƒãƒƒãƒ—ï¼ˆ5è»¸ã€éæ•°å€¤ï¼‰+ ã‚¾ãƒ¼ãƒ³è¡¨ç¤ºï¼ˆè‚²æˆ/å®‰å®š/å¼·åŒ–ï¼‰
            try{
              const me = loadProviders().find(p=> p.id===session.id) || {};
              const sc = (me.onboarding && me.onboarding.scores) ? me.onboarding.scores : { A:2, B:2, C:2, D:2, E_tags:[] };
              const prof = (me.onboarding && me.onboarding.profile) ? me.onboarding.profile : {};
              function level3(val){ return val>=3? 'green' : (val===2? 'yellow' : 'none'); }
              const axes = [
                { key:'motivation', label:'å‹•æ©Ÿã®æ·±ã•', lvl: level3(Number(sc.A||2)) },
                { key:'anxiety', label:'ä¸å®‰ã¸ã®å‘ãåˆã„æ–¹', lvl: level3(Number(sc.B||2)) },
                { key:'change', label:'å¤‰åŒ–ã®å¼·ã•', lvl: level3(Number(sc.C||2)) },
                { key:'style', label:'é€²ã‚æ–¹ã‚¹ã‚¿ã‚¤ãƒ«', lvl: (Number(sc.D||2)===2? 'green' : 'yellow') },
                { key:'values', label:'å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³', lvl: (Array.isArray(sc.E_tags) && sc.E_tags.length>=2? 'green' : (Array.isArray(sc.E_tags) && sc.E_tags.length===1? 'yellow' : 'none')) }
              ];
              const greens = axes.filter(a=> a.lvl==='green').length;
              const zoneName = greens>=3? 'ğŸ”¥ å¼·åŒ–ã‚¾ãƒ¼ãƒ³' : (greens===2? 'ğŸŒ¿ å®‰å®šã‚¾ãƒ¼ãƒ³' : 'ğŸŒ± è‚²æˆã‚¾ãƒ¼ãƒ³');
              const compat = document.createElement('div'); compat.className='card'; compat.style.padding='12px'; compat.style.marginTop='12px';
              const header = document.createElement('div'); header.className='cluster'; header.style.justifyContent='space-between'; header.style.alignItems='center';
              const title = document.createElement('strong'); title.textContent='ç›¸æ€§ãƒãƒƒãƒ—ï¼ˆéæ•°å€¤ï¼‰'; header.appendChild(title);
              const link = document.createElement('a'); link.className='btn btn-ghost'; link.href='./compatibility.html'; link.textContent='è©³ã—ãè¦‹ã‚‹'; header.appendChild(link);
              compat.appendChild(header);
              const copy = document.createElement('p'); copy.className='muted'; copy.style.margin='8px 0'; copy.textContent='ã“ã®ãƒãƒƒãƒ—ã¯è‰¯ã—æ‚ªã—ã§ã¯ãªãã€ä»Šã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒã©ã‚“ãªäººã«å±Šã„ã¦ã„ã‚‹ã‹ã®åˆ°é”åº¦è¡¨ç¤ºã§ã™ã€‚'; compat.appendChild(copy);
              const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='1fr 1fr'; grid.style.gap='8px';
              function badge(axisKey, label, lvl){
                const b = document.createElement('button'); b.type='button'; b.style.display='flex'; b.style.justifyContent='space-between'; b.style.alignItems='center'; b.style.padding='8px 10px'; b.style.border='1px solid #e5e7eb'; b.style.borderRadius='10px'; b.style.cursor='pointer'; b.style.background='#fff'; b.setAttribute('aria-label', label+' ã®æ”¹å–„ææ¡ˆã‚’é–‹ã');
                const name = document.createElement('span'); name.textContent = label; b.appendChild(name);
                const tag = document.createElement('span'); tag.style.borderRadius='999px'; tag.style.fontSize='12px'; tag.style.padding='2px 10px';
                if(lvl==='green'){ tag.textContent='ã‚ˆãå±Šã„ã¦ã„ã‚‹'; tag.style.background='#10b981'; tag.style.color='#fff'; }
                else if(lvl==='yellow'){ tag.textContent='ã‚‚ã†å°‘ã—ã§å±Šã'; tag.style.background='#f59e0b'; tag.style.color='#fff'; }
                else { tag.textContent='ã¾ã ä¼ã‚ã£ã¦ã„ãªã„'; tag.style.background='#e5e7eb'; tag.style.color='#111827'; }
                b.appendChild(tag);
                b.addEventListener('click', ()=> openAxisPopup(axisKey, label, lvl));
                return b;
              }
              // è»¸ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
              function openAxisPopup(key, label, lvl){
                const backdrop = document.createElement('div'); backdrop.id='axis-modal-backdrop'; backdrop.style.position='fixed'; backdrop.style.inset='0'; backdrop.style.background='rgba(0,0,0,0.35)'; backdrop.style.backdropFilter='blur(2px)'; backdrop.style.zIndex='999';
                const modal = document.createElement('div'); modal.id='axis-modal'; modal.style.position='fixed'; modal.style.inset='0'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.padding='24px'; modal.style.zIndex='1000';
                const card = document.createElement('div'); card.className='card'; card.style.maxWidth='560px'; card.style.width='100%'; card.style.padding='16px'; card.style.borderRadius='12px';
                const head = document.createElement('div'); head.className='cluster'; head.style.justifyContent='space-between'; head.style.alignItems='center';
                const h = document.createElement('strong'); h.textContent = `ã€${label}ã€‘æ”¹å–„ææ¡ˆ`; head.appendChild(h);
                const close = document.createElement('button'); close.className='btn btn-ghost'; close.type='button'; close.textContent='é–‰ã˜ã‚‹'; close.addEventListener('click', removeModal); head.appendChild(close);
                card.appendChild(head);
                const p = document.createElement('p'); p.className='muted'; p.style.margin='8px 0';
                const actionsWrap = document.createElement('div'); actionsWrap.className='stack'; actionsWrap.style.marginTop='8px'; actionsWrap.style.gap='6px';
                // è»¸åˆ¥ã®å…·ä½“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¯¾å¿œï¼‰
                const map = {
                  motivation: {
                    intro:'ã€Œã©ã‚“ãªæ‚©ã¿ã®ç”·æ€§ã«å‘ãåˆã£ã¦ããŸã‹ã€ã‚’å…·ä½“åŒ–ã™ã‚‹ã¨ã€å‹•æ©ŸãŒä¼ã‚ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚',
                    actions:[
                      {text:'ã‚ªãƒ³ãƒœï½œã©ã‚“ãªæ‚©ã¿ã‚’è¿½è¨˜', href:'./onboarding.html#reedit&focus=ob-q-problems'}
                    ]
                  },
                  anxiety: {
                    intro:'åˆå›ã§ã®ä¸å®‰è§£æ¶ˆã®å§¿å‹¢ãŒä¼ã‚ã‚‹ã¨ã€ã“ã®è»¸ã¯ä¸ŠãŒã‚Šã¾ã™ã€‚',
                    actions:[
                      {text:'ã‚ªãƒ³ãƒœï½œåˆã‚ã¦ã®äººã¸ã®å¯„ã‚Šæ·»ã„', href:'./onboarding.html#reedit&focus=ob-q-first'},
                      {text:'ã‚µãƒ¼ãƒ“ã‚¹ï½œå¤±æ•—ãƒªã‚¹ã‚¯ã¸ã®å‘ãåˆã„æ–¹', href:'./service_form.html?select=auto&focus=riskPolicy'},
                      {text:'ã‚µãƒ¼ãƒ“ã‚¹ï½œQ&Aã«ä¸å®‰ã¸ã®å›ç­”ã‚’è¿½åŠ ', href:'./service_form.html?select=auto&focus=qa-list'}
                    ]
                  },
                  change: {
                    intro:'æä¾›ã™ã‚‹å¤‰åŒ–ãƒ¬ãƒ³ã‚¸ï¼ˆå°‘ã—æ•´ãˆã‚‹ã€œåˆ¥äººãƒ¬ãƒ™ãƒ«ï¼‰ã‚’æ˜è¨˜ã—ã¾ã—ã‚‡ã†ã€‚',
                    actions:[
                      {text:'ã‚µãƒ¼ãƒ“ã‚¹ï½œåˆå›ã®é€²ã‚æ–¹ã«å¤‰åŒ–ãƒ¬ãƒ³ã‚¸', href:'./service_form.html?select=auto&focus=firstSessionPlan'},
                      {text:'ã‚ªãƒ³ãƒœï½œæä¾›ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆCï¼‰ã‚’è¦‹ç›´ã™', href:'./onboarding.html#reedit&focus=ob-c-group'}
                    ]
                  },
                  style: {
                    intro:'æ„æ€æ±ºå®šã®é–¢ã‚ã‚Šæ–¹ï¼ˆç›¸è«‡/ææ¡ˆ/å§”ã­ã‚‹ï¼‰ã‚’è¨€èªåŒ–ã—ã¾ã—ã‚‡ã†ã€‚',
                    actions:[
                      {text:'ã‚ªãƒ³ãƒœï½œæ„æ€æ±ºå®šã®é–¢ã‚ã‚Šæ–¹ï¼ˆDï¼‰', href:'./onboarding.html#reedit&focus=ob-d-group'},
                      {text:'ã‚ªãƒ³ãƒœï½œåˆã‚ã¦ã®äººã¸ã®å¯„ã‚Šæ·»ã„', href:'./onboarding.html#reedit&focus=ob-q-first'}
                    ]
                  },
                  values: {
                    intro:'ä¾¡å€¤è¦³ã‚¿ã‚°ï¼ˆå®‰å¿ƒãƒ»ç†è«–ãƒ»ã‚»ãƒ³ã‚¹ãƒ»å®Ÿç¸¾ï¼‰ã‚’2ã¤ä»¥ä¸Šï¼‹ä½•ã§é¸ã°ã‚ŒãŸã„ã‹ã‚’è£œè¶³ã—ã¾ã—ã‚‡ã†ã€‚',
                    actions:[
                      {text:'ã‚ªãƒ³ãƒœï½œä¾¡å€¤è¦³ã‚¿ã‚°ã‚’é¸ã¶', href:'./onboarding.html#reedit&focus=ob-e-group'},
                      {text:'ã‚ªãƒ³ãƒœï½œä¾¡æ ¼ã§ã¯ãªãä½•ã§é¸ã°ã‚ŒãŸã„ã‹', href:'./onboarding.html#reedit&focus=ob-q-beyond'}
                    ]
                  }
                };
                const tip = map[key] || { intro:'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«å…·ä½“çš„ãªè¨€è‘‰ã‚’å¢—ã‚„ã—ã¦ãã ã•ã„ã€‚', actions:[{text:'ã‚ªãƒ³ãƒœã¸', href:'./onboarding.html#reedit'}] };
                p.textContent = tip.intro;
                card.appendChild(p);
                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ç¾¤
                tip.actions.forEach(act=>{
                  const a = document.createElement('a'); a.className='btn btn-ghost'; a.href=act.href; a.textContent=act.text; actionsWrap.appendChild(a);
                });
                card.appendChild(actionsWrap);
                modal.appendChild(card);
                function removeModal(){ try{ document.body.removeChild(backdrop); document.body.removeChild(modal); }catch{} }
                backdrop.addEventListener('click', removeModal);
                document.body.appendChild(backdrop); document.body.appendChild(modal);
              }
              axes.forEach(a=> grid.appendChild(badge(a.key, a.label, a.lvl)));
              compat.appendChild(grid);
              const zone = document.createElement('div'); zone.style.marginTop='10px'; zone.innerHTML = `<strong>ç¾åœ¨ã®ã‚¾ãƒ¼ãƒ³ï¼š</strong> ${zoneName}`; compat.appendChild(zone);
              const hint = document.createElement('p'); hint.className='muted'; hint.style.margin='6px 0 0'; hint.textContent='å„è»¸ã‚’å¼·åŒ–ã™ã‚‹ã«ã¯ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«å…·ä½“çš„ãªè¨€è‘‰ã‚’å¢—ã‚„ã—ã¦ãã ã•ã„ï¼ˆåˆå›ã®å‘ãåˆã„æ–¹ãƒ»ä¾¡å€¤è¦³ãƒ»å¾—æ„ãªå¤‰åŒ–ãªã©ï¼‰ã€‚'; compat.appendChild(hint);
              container.insertBefore(compat, container.children[2] || null);
            }catch(_){ }
            // æ”¹å–„ææ¡ˆã‚«ãƒ¼ãƒ‰ï¼ˆã©ã“ã«ä½•ã‚’æ›¸ã‘ã°ä¸ŠãŒã‚‹ã‹ï¼‰
            try{
              const SERVICES_KEY = 'glowup:services';
              const loadServices = ()=>{ try{ const raw=localStorage.getItem(SERVICES_KEY); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[]; }catch{ return []; } };
              const myServices = loadServices().filter(s=> s && s.providerId===session.id);
              const tips = [];
              // é›†è¨ˆï¼šä¸è¶³ã«å¿œã˜ã¦ææ¡ˆã‚’ä½œæˆ
              for(const svc of myServices){
                const name = svc.name || 'ã‚µãƒ¼ãƒ“ã‚¹';
                const fsLen = (svc.firstSessionPlan||'').length;
                const rpLen = (svc.riskPolicy||'').length;
                const qaCnt = Array.isArray(svc.qaList)? svc.qaList.filter(it=> it&&it.q&&it.a).length : 0;
                const descLen = (svc.description||'').length;
                if(fsLen < 80){ tips.push({ k:'fs', text:`ã€Œ${name}ã€ã®åˆå›ã®é€²ã‚æ–¹ï¼š80ã€œ150å­—ã§å…·ä½“åŒ–ï¼ˆä¾‹ãƒ»æ‰‹é †/æ‰€è¦æ™‚é–“/åˆæ„ã®å–ã‚Šæ–¹ï¼‰`, href:'./service_form.html' }); }
                if(rpLen < 60){ tips.push({ k:'rp', text:`ã€Œ${name}ã€ã®å¤±æ•—ãƒªã‚¹ã‚¯ã¸ã®å‘ãåˆã„æ–¹ï¼š60å­—ä»¥ä¸Šã§è£œè¶³ï¼ˆç¢ºèªãƒ»ä¿®æ­£ãƒ»ä¿è¨¼ï¼‰`, href:'./service_form.html' }); }
                if(qaCnt < 2){ tips.push({ k:'qa', text:`ã€Œ${name}ã€ã®Q&Aï¼šã‚ˆãã‚ã‚‹ä¸å®‰ã¸ã®å›ç­”ã‚’2ä»¶ä»¥ä¸Šè¿½åŠ `, href:'./service_form.html' }); }
                if(descLen < 150){ tips.push({ k:'desc', text:`ã€Œ${name}ã€ã®æœ¬æ–‡ï¼š150å­—ä»¥ä¸Šã§å…·ä½“åŒ–ï¼ˆå†…å®¹/æ‰€è¦æ™‚é–“/æŒã¡ç‰©ï¼‰`, href:'./service_form.html' }); }
              }
              // é‡è¤‡ã‚­ãƒ¼ã‚’é™¤å»ã—ã¦ä¸Šä½3ä»¶ã ã‘è¡¨ç¤º
              const seen = new Set(); const dedup = [];
              for(const t of tips){ if(seen.has(t.k)) continue; seen.add(t.k); dedup.push(t); if(dedup.length>=3) break; }
              if(dedup.length){
                const sugg = document.createElement('div'); sugg.className='card'; sugg.style.padding='12px'; sugg.style.marginTop='12px';
                const title = document.createElement('div'); title.className='cluster'; title.style.justifyContent='space-between'; title.style.alignItems='center';
                const strong = document.createElement('strong'); strong.textContent='æ”¹å–„ææ¡ˆï¼ˆã©ã“ã«ä½•ã‚’æ›¸ãã¨ä¸ŠãŒã‚‹ã‹ï¼‰'; title.appendChild(strong);
                const link = document.createElement('a'); link.className='btn btn-ghost'; link.href='./service_form.html'; link.textContent='ã‚µãƒ¼ãƒ“ã‚¹ç·¨é›†ã¸'; title.appendChild(link);
                sugg.appendChild(title);
                const ul = document.createElement('ul'); ul.className='stack'; ul.style.marginTop='8px';
                for(const t of dedup){ const li=document.createElement('li'); const a=document.createElement('a'); a.href=t.href; a.className='btn btn-ghost'; a.textContent='ç·¨é›†'; li.appendChild(document.createTextNode(t.text)); li.appendChild(document.createTextNode(' ')); li.appendChild(a); ul.appendChild(li); }
                sugg.appendChild(ul);
                container.insertBefore(sugg, container.children[2] || null);
              }
            }catch(e){ /* ignore */ }

            // ä»Šæœˆã®æŒ‡æ¨™ã‚«ãƒ¼ãƒ‰ï¼ˆäºˆç´„æ•°ãƒ»ã‚¢ã‚¯ã‚»ã‚¹æ•°ãƒ»äººæ°—ã‚µãƒ¼ãƒ“ã‚¹ãƒ»ä»Šæœˆã®æ‰‹æ•°æ–™ï¼‰
            try{
              const metricsCard = document.createElement('div'); metricsCard.className='card'; metricsCard.style.padding='12px'; metricsCard.style.marginTop='12px';
              const head = document.createElement('div'); head.className='cluster'; head.style.justifyContent='space-between'; head.style.alignItems='center';
              const h = document.createElement('strong'); h.textContent='ğŸ“ˆ ä»Šæœˆã®æŒ‡æ¨™'; head.appendChild(h);
              metricsCard.appendChild(head);
              const wrap = document.createElement('div'); wrap.className='stack'; wrap.style.marginTop='8px';

              function ymKey(iso){ try{ const d=new Date(iso); return `${d.getFullYear()}-${d.getMonth()+1}`; }catch{ return ''; } }
              const now = new Date(); const ym = `${now.getFullYear()}-${now.getMonth()+1}`;
              const last = new Date(now.getFullYear(), now.getMonth()-1, 1); const yml = `${last.getFullYear()}-${last.getMonth()+1}`;

              // äºˆç´„ã¨æ‰‹æ•°æ–™ï¼ˆpoints/reservationsãƒ™ãƒ¼ã‚¹ï¼‰
              let reservations = []; try{ const raw=localStorage.getItem('fineme:reservations:list'); reservations = raw? JSON.parse(raw): []; }catch{}
              const mine = Array.isArray(reservations) ? reservations.filter(r=> String(r.storeId||'')===String(session.id)) : [];
              const effectiveStatuses = new Set(['reserved','visit_pending','visited']);
              const curResv = mine.filter(r=> effectiveStatuses.has(String(r.status||'')) && ymKey(r.visitDate)===ym);
              const prevResv = mine.filter(r=> effectiveStatuses.has(String(r.status||'')) && ymKey(r.visitDate)===yml);
              const resvCount = curResv.length;
              const resvDiff = resvCount - prevResv.length;
              const visitedThisMonth = mine.filter(r=> String(r.status||'')==='visited' && ymKey(r.visitDate)===ym);
              const feeThisMonth = visitedThisMonth.reduce((sum, r)=> sum + (Number(r.price||0) * (Number(r.commissionRate||0)/100)), 0);

              // ã‚¢ã‚¯ã‚»ã‚¹æ•°ãƒ»äººæ°—ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆviewHistoryãƒ™ãƒ¼ã‚¹ï¼‰
              let history = []; try{ const raw=localStorage.getItem('glowup:viewHistory'); history = raw? JSON.parse(raw): []; }catch{}
              const myHist = Array.isArray(history) ? history.filter(h=> String(h.providerId||'')===String(session.id)) : [];
              const curAccess = myHist.filter(h=> ymKey(h.viewedAt||h.createdAt||Date.now())===ym).length;
              const prevAccess = myHist.filter(h=> ymKey(h.viewedAt||h.createdAt||Date.now())===yml).length;
              const accessDiff = curAccess - prevAccess;

              // äººæ°—ã‚µãƒ¼ãƒ“ã‚¹ä¸Šä½3ï¼ˆä»Šæœˆï¼‰
              function pickServiceKey(href){
                try{
                  const u = new URL(href, location.origin);
                  const sid = u.searchParams.get('serviceId');
                  return sid ? `sid:${sid}` : `href:${u.pathname}${u.search}`;
                }catch{ return String(href||''); }
              }
              const curHist = myHist.filter(h=> ymKey(h.viewedAt||h.createdAt||Date.now())===ym);
              const counts = new Map(); const names = new Map();
              for(const it of curHist){ const key = pickServiceKey(it.href||''); counts.set(key, (counts.get(key)||0)+1); if(!names.has(key)) names.set(key, it.name||'ã‚µãƒ¼ãƒ“ã‚¹'); }
              const top = Array.from(counts.entries()).map(([k,v])=>({ key:k, count:v, name:names.get(k)||'ã‚µãƒ¼ãƒ“ã‚¹' })).sort((a,b)=> b.count-a.count).slice(0,3);

              // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
              const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit, minmax(180px, 1fr))'; grid.style.gap='10px';
              function metric(label, value, diff){
                const box = document.createElement('div'); box.style.border='1px solid #e5e7eb'; box.style.borderRadius='10px'; box.style.padding='10px'; box.style.background='#fff';
                const l = document.createElement('div'); l.className='muted'; l.textContent = label; box.appendChild(l);
                const v = document.createElement('div'); v.style.fontSize='18px'; v.style.fontWeight='700'; v.textContent = value; box.appendChild(v);
                if(typeof diff === 'number'){
                  const d = document.createElement('div'); d.className='muted'; d.style.fontSize='12px'; d.style.marginTop='2px'; d.textContent = `å…ˆæœˆæ¯” ${diff>=0?'+':''}${diff}`; box.appendChild(d);
                }
                return box;
              }
              grid.appendChild(metric('äºˆç´„æ•°ï¼ˆä»Šæœˆï¼‰', `${resvCount}ä»¶`, resvDiff));
              grid.appendChild(metric('ã‚¢ã‚¯ã‚»ã‚¹æ•°ï¼ˆä»Šæœˆï¼‰', `${curAccess}å›`, accessDiff));
              grid.appendChild(metric('ä»Šæœˆã®æ‰‹æ•°æ–™', `Â¥${Math.round(feeThisMonth).toLocaleString()}`));
              wrap.appendChild(grid);

              // äººæ°—ã‚µãƒ¼ãƒ“ã‚¹
              const popular = document.createElement('div'); popular.className='stack'; popular.style.marginTop='8px';
              const ph = document.createElement('div'); ph.className='muted'; ph.textContent='ã‚¢ã‚¯ã‚»ã‚¹ãŒå¤šã„ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä»Šæœˆï¼‰'; popular.appendChild(ph);
              if(top.length){
                const ul = document.createElement('ul'); ul.className='stack'; ul.style.marginTop='6px';
                for(const t of top){ const li=document.createElement('li'); li.textContent = `${t.name}ï¼š${t.count}å›`; ul.appendChild(li); }
                popular.appendChild(ul);
              } else {
                const empty = document.createElement('div'); empty.className='muted'; empty.textContent='â€” ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'; popular.appendChild(empty);
              }
              wrap.appendChild(popular);

              metricsCard.appendChild(wrap);
              container.insertBefore(metricsCard, container.children[3] || null);
            }catch(_){ }

            // ç›¸æ€§çµŒç”±ç‡ã‚«ãƒ¼ãƒ‰ï¼ˆé †ä½ã®ä»£æ›¿æŒ‡æ¨™ï¼‰
            try{
              const ratioCard = document.createElement('div'); ratioCard.className='card'; ratioCard.style.padding='12px'; ratioCard.style.marginTop='12px';
              const head = document.createElement('div'); head.className='cluster'; head.style.justifyContent='space-between'; head.style.alignItems='center';
              const h = document.createElement('strong'); h.textContent='ğŸ“Š ç›¸æ€§çµŒç”±ç‡ï¼ˆä»Šæœˆï¼‰'; head.appendChild(h);
              ratioCard.appendChild(head);
              const desc = document.createElement('p'); desc.className='muted'; desc.style.margin='8px 0'; desc.textContent='Finemeã®è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ã«ã‚ˆã‚Šã€Œä»Šã®çŠ¶æ…‹ã«åˆã†ã€ã¨åˆ¤æ–­ã•ã‚Œã¦æ¥åº—ã—ãŸå‰²åˆã®ç›®å®‰ã§ã™ï¼ˆé †ä½ã®ä»£ã‚ã‚Šã«ä½¿ã†æŒ‡æ¨™ï¼‰ã€‚'; ratioCard.appendChild(desc);
              const val = document.createElement('div'); val.style.fontWeight='700'; val.style.fontSize='16px'; val.textContent='â€”%'; ratioCard.appendChild(val);
              const copy = document.createElement('p'); copy.className='muted'; copy.style.margin='6px 0 0'; ratioCard.appendChild(copy);
              // é›†è¨ˆï¼ˆæš«å®šãƒ­ã‚¸ãƒƒã‚¯ï¼‰ï¼šå½“æœˆè¨ªå•ã®ã†ã¡ã€è¨ºæ–­ã‚ã‚Šï¼‹ç›¸æ€§è»¸ãŒ3æœ¬ä»¥ä¸Šå±Šã„ã¦ã„ã‚‹ï¼ˆç·‘ï¼‰ã‚’ã€Œç›¸æ€§çµŒç”±ã€ã¨ã¿ãªã™
              const ptsRaw = localStorage.getItem('fineme:reservations:list');
              const reservations = ptsRaw ? JSON.parse(ptsRaw) : [];
              const now = new Date(); const ym = `${now.getFullYear()}-${now.getMonth()+1}`;
              const mine = Array.isArray(reservations) ? reservations.filter(r=> String(r.storeId||'') === String(session.id)) : [];
              function ymKey(iso){ try{ const d=new Date(iso); return `${d.getFullYear()}-${d.getMonth()+1}`; }catch{ return ''; } }
              const monthVisits = mine.filter(r=> ymKey(r.visitDate)===ym && r.status==='visited');
              // è¨ºæ–­ã®å­˜åœ¨ï¼ˆç°¡æ˜“ï¼‰
              let diagExists = false; try{ const raw=localStorage.getItem('fineme:diagnosis:latest'); const obj=raw?JSON.parse(raw):null; diagExists = !!(obj && obj.intent && obj.how && obj.why); }catch{}
              // è»¸ç·‘æ•°
              const sc = (loadProviders().find(p=> p.id===session.id)?.onboarding?.scores) || { A:2,B:2,C:2,D:2,E_tags:[] };
              const greens = [Number(sc.A||2)>=3, Number(sc.B||2)>=3, Number(sc.C||2)>=3, Number(sc.D||2)===2, Array.isArray(sc.E_tags)&&sc.E_tags.length>=2].filter(Boolean).length;
              const affinityVisits = monthVisits.filter(r=> String(r.origin||'') === 'affinity').length;
              const totalVisits = monthVisits.length || 0;
              const ratio = totalVisits ? Math.round((affinityVisits/totalVisits)*100) : 0;
              val.textContent = `${ratio}%`;
              // çŠ¶æ…‹åˆ¥ã‚³ãƒ”ãƒ¼
              if(ratio <= 20){ copy.textContent = 'ç¾åœ¨ã¯æ¤œç´¢ãƒ»ã‚«ãƒ†ã‚´ãƒªèµ·ç‚¹ã®æ¥åº—ãŒä¸­å¿ƒã§ã™ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®è¨€èªåŒ–ã§ã€Œç›¸æ€§èµ·ç‚¹ã€ã®é¸æŠãŒå¢—ãˆã¾ã™ã€‚'; }
              else if(ratio <= 40){ copy.textContent = 'ã€Œç†è§£ã€ã§é¸ã°ã‚Œã‚‹æ¥åº—ãŒå¢—ãˆå§‹ã‚ã¦ã„ã¾ã™ã€‚ç›¸æ€§èµ·ç‚¹ã®å‰²åˆãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚'; }
              else if(ratio <= 60){ copy.textContent = 'æ¥åº—ã®å¤šããŒç›¸æ€§ã‚’èµ·ç‚¹ã«ã—ã¦ã„ã¾ã™ã€‚ãƒªãƒ”ãƒ¼ãƒˆç‡ãƒ»æº€è¶³åº¦ãŒå®‰å®šã—ã‚„ã™ã„çŠ¶æ…‹ã§ã™ã€‚'; }
              else { copy.textContent = 'ã‚ãªãŸã®ãƒšãƒ¼ã‚¸ã¯ã€Œä»Šã®çŠ¶æ…‹ã«åˆã†é¸æŠè‚¢ã€ã¨ã—ã¦æ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚FinemeãŒç›®æŒ‡ã™ç†æƒ³çš„ãªæ²è¼‰çŠ¶æ…‹ã§ã™ã€‚'; }
              container.insertBefore(ratioCard, container.children[3] || null);
            }catch(_){ }
          }
        }catch(_){ }
      };
      // partials.js ãŒå…¬é–‹ã™ã‚‹æº–å‚™å®Œäº†ã«åˆã‚ã›ã‚‹
      try{
        if(window.finemePartials && window.finemePartials.provNavReady){
          window.finemePartials.provNavReady.then(() => boot());
        } else {
          document.addEventListener('fineme:provNavReady', () => boot(), { once: true });
          // å¿µã®ãŸã‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          setTimeout(boot, 500);
        }
      }catch{ boot(); }
    }
  </script>
</body>
</html>
