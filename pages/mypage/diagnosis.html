<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>診断結果 | Fineme</title>
  <link rel="stylesheet" href="../../assets/styles/style.css" />
  <link rel="stylesheet" href="../../assets/styles/components.css" />
  <style>
    /* このページ限定でボタンを濃色にして視認性を確保 */
    .card .btn{ background:#111 !important; color:#fff !important; border:none !important; box-shadow:0 6px 16px rgba(0,0,0,0.16) }
    .card .btn-ghost{ background:transparent !important; color:#111 !important; border:1px solid #111 !important }
  </style>
</head>
<body>
  <header id="site-header"></header>
  <main class="section">
    <div class="container mypage-layout">
      <aside id="mypage-sidenav"></aside>
      <section class="stack">
        <h1 class="section-title">診断結果</h1>
        <div id="diag-host" class="stack"></div>
      </section>
    </div>
  </main>
  <footer id="site-footer"></footer>
  <script src="../../scripts/main.js" type="module"></script>
  <script src="../../scripts/partials.js" type="module"></script>
  <script type="module">
    import { requireUserAuth } from '../../scripts/user-auth.js';
    requireUserAuth();
  </script>
  <script>
  (function(){
    const STORAGE_KEY = 'fineme:diagnosis:latest';
    const SAVED_KEY = 'fineme:saved:diagnoses';
    const TYPES_URL = '/data/intent-types.json';
    const host = document.getElementById('diag-host');
    function showToast(msg){ try{ const t = document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); requestAnimationFrame(()=>{ t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(), 300); }, 1800); }); }catch{} }
    function emptyState(){
      const card = document.createElement('div'); card.className='card'; card.style.padding='16px';
      const p = document.createElement('p'); p.className='muted'; p.textContent='診断結果が見つかりません。過去に診断を完了していないか、保存されていない可能性があります。';
      const actions = document.createElement('div'); actions.className='cluster'; actions.style.gap='8px';
      const a1 = document.createElement('a'); a1.className='btn'; a1.href='/diagnosis/index.html'; a1.textContent='無料で診断する（3分）';
      const a2 = document.createElement('a'); a2.className='btn btn-ghost'; a2.href='/pages/search.html'; a2.textContent='診断せずに探す';
      actions.appendChild(a1); actions.appendChild(a2);
      card.appendChild(p); card.appendChild(actions);
      host.appendChild(card);
    }
    function fmtDate(ts){ try{ const d=new Date(ts); return d.toLocaleString('ja-JP'); }catch{ return ''; } }
    function loadSaved(){ try{ const raw = localStorage.getItem(SAVED_KEY); const arr = raw? JSON.parse(raw): []; return Array.isArray(arr)? arr: []; }catch{ return []; } }
    function saveListCard(){
      const arr = loadSaved();
      const card = document.createElement('div'); card.className='card'; card.style.padding='16px';
      const h2 = document.createElement('h2'); h2.textContent = '保存した診断'; h2.style.margin='0 0 8px'; card.appendChild(h2);
      if(!arr.length){ const p=document.createElement('p'); p.className='muted'; p.textContent='まだ保存はありません。結果ページやトップから「保存」を押すと表示されます。'; card.appendChild(p); host.appendChild(card); return; }
      const list = document.createElement('div'); list.className='stack'; list.style.gap='8px';
      arr.forEach((it, idx)=>{
        const row = document.createElement('div'); row.className='cluster'; row.style.justifyContent='space-between'; row.style.alignItems='center';
        const left = document.createElement('div'); const t=document.createElement('strong'); t.textContent = it.typeName || '(不明なタイプ)'; left.appendChild(t); const s=document.createElement('span'); s.className='muted'; s.style.marginLeft='8px'; s.textContent = fmtDate(it.savedAt); left.appendChild(s);
        const right = document.createElement('div'); const open=document.createElement('a'); open.className='btn btn-ghost'; open.href='/diagnosis/result.html'; open.textContent='詳しく見る'; const del=document.createElement('button'); del.className='btn btn-ghost'; del.textContent='削除'; del.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); try{ const arr2 = loadSaved().filter((x,i)=> i!==idx); localStorage.setItem(SAVED_KEY, JSON.stringify(arr2)); showToast('保存を削除しました'); card.remove(); saveListCard(); }catch{} }); right.appendChild(open); right.appendChild(del);
        row.appendChild(left); row.appendChild(right); list.appendChild(row);
      });
      card.appendChild(list); host.appendChild(card);
    }
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ emptyState(); return; }
      const obj = JSON.parse(raw);
      const typeId = obj?.intent?.type_id;
      const typeName = (obj?.step2?.classification?.type_name) || (obj?.intent?.type_name) || '';
      const updated = obj?.at ? fmtDate(obj.at) : '';
      const top = document.createElement('div'); top.className='card'; top.style.padding='16px';
      const h = document.createElement('h2'); h.textContent = typeName ? `あなたは「${typeName}」です` : '診断結果'; top.appendChild(h);
      if(updated){ const small = document.createElement('p'); small.className='muted'; small.textContent = `最終更新: ${updated}`; top.appendChild(small); }
      const actions = document.createElement('div'); actions.className='cluster'; actions.style.gap='8px';
      const re = document.createElement('a'); re.href='/diagnosis/index.html'; re.className='btn'; re.textContent='診断をやり直す'; re.style.color = '#111'; re.style.setProperty('color','#111','important'); actions.appendChild(re);
      const see = document.createElement('a'); see.href='/diagnosis/result.html'; see.className='btn btn-ghost'; see.textContent='結果ページで詳しく見る'; actions.appendChild(see);
      top.appendChild(actions);
      host.appendChild(top);
      saveListCard();
      try{ const just = sessionStorage.getItem('fineme:saved:just') === '1'; if(just){ showToast('診断を保存しました'); sessionStorage.removeItem('fineme:saved:just'); } }catch{}
      if(!typeId){ return; }
      fetch(TYPES_URL).then(r=>r.json()).then(types=>{
        const entry = types[typeId]; if(!entry) return;
        const card = document.createElement('div'); card.className='card'; card.style.padding='16px';
        const p1 = document.createElement('p'); p1.textContent = entry.catch || ''; card.appendChild(p1);
        // 視点ブロック（保存データから軸を利用）
        (function(){
          const axes = (obj?.step2?.scores?.axes) || {};
          const typeId = (obj?.step2?.classification?.type_id) || 't01';
          function toList(arr){ const ul=document.createElement('ul'); arr.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); }); return ul; }
          const wrap = document.createElement('div'); wrap.className='stack'; wrap.style.gap='8px';
          const title = document.createElement('h3'); title.textContent='進め方の視点'; wrap.appendChild(title);
          const mindset = [];
          if(Number(axes.motivation)>0) mindset.push('目的と再現性を重視');
          if(Number(axes.support)>0) mindset.push('伴走や確認を重視');
          if(Number(axes.control)>0) mindset.push('主導権/共同決定を重視');
          if(Number(axes.change)>0) mindset.push('変化の実感を早めたい');
          if(!mindset.length) mindset.push('自分に合う進め方を選ぶ');
          const mH = document.createElement('h4'); mH.textContent='考え方の特徴'; wrap.appendChild(mH); wrap.appendChild(toList(mindset));
          const chooseMap = {
            t01:['事前説明/比較検討ができる','レビューや事例が豊富'],
            t02:['相談/チェックの伴走がある','柔軟な調整ができる'],
            t03:['短期プラン/成果指標が明確','写真で比較できる事例'],
            t04:['更新提案/小さなテストができる'],
            t05:['世界観が合うポートフォリオ','事例写真が豊富'],
            t06:['継続サポート/習慣化の仕組み','定期的な振り返り']
          };
          function labelWeight(lab){
            const s = Number(axes.support)||0, c = Number(axes.change)||0, m = Number(axes.motivation)||0, ctrl = Number(axes.control)||0;
            const L = String(lab);
            if(/相談|チェック|伴走/.test(L)) return s*2 + m;
            if(/可視化|事前説明|納得|透明/.test(L)) return m*2 + ctrl;
            if(/比較検討/.test(L)) return ctrl*2 + m;
            if(/短期|成果指標|早い|仮説検証/.test(L)) return c*2 + m;
            if(/写真/.test(L)) return c*1.5 + m;
            if(/更新提案|チャレンジ|小さく試/.test(L)) return c*2 + s;
            if(/柔軟|調整/.test(L)) return s*2 + ctrl;
            if(/世界観|雰囲気/.test(L)) return 0.5;
            if(/習慣化|振り返り|継続/.test(L)) return s*2 + m;
            return 0;
          }
          const baseChoose = (chooseMap[typeId] || chooseMap.t01).slice();
          const sortedChoose = baseChoose.slice().sort((a,b)=> labelWeight(b) - labelWeight(a));
          const chooseWeights = sortedChoose.map(x=> labelWeight(x));
          const chooseSpread = (chooseWeights.length? (Math.max(...chooseWeights)-Math.min(...chooseWeights)): 0);
          const sumAxes = ['support','change','control','motivation'].map(k=> Number((axes||{})[k])||0).reduce((p,c)=> p+c, 0);
          const showChooseRanks = chooseSpread > 0.5 && sumAxes > 0;
          const cH = document.createElement('h4'); cH.textContent='選び方'; wrap.appendChild(cH);
          const chooseUl = document.createElement('ul'); sortedChoose.forEach((t,i)=>{ const li=document.createElement('li'); li.textContent=t; if(showChooseRanks){ const b=document.createElement('span'); b.textContent=` 優先度 ${i+1}`; b.style.marginLeft='6px'; b.style.padding='2px 6px'; b.style.border='1px solid var(--color-border)'; b.style.borderRadius='999px'; b.style.fontSize='12px'; li.appendChild(b); } chooseUl.appendChild(li); }); wrap.appendChild(chooseUl);
          if(!showChooseRanks){ const note=document.createElement('p'); note.className='muted'; note.textContent='※ 軸の差が小さいため、選び方の順位付けは行っていません（同程度）。'; wrap.appendChild(note); }
          // 根拠注釈
          try{
            const pairs = [['support','寄り添い/相談'],['change','変化の強さ'],['control','主導権/共同決定'],['motivation','目的の明確さ']]
              .map(([k,lab])=>({ k, lab, v: Number((axes||{})[k])||0 }))
              .sort((a,b)=> b.v - a.v).slice(0,2);
            const note = document.createElement('p'); note.className='muted'; note.textContent = pairs.length? `※ あなたの回答（軸：${pairs.map(p=> p.lab).join('・')}）に基づいて並びを調整しています。` : '※ あなたの回答に基づいて表示しています。';
            wrap.appendChild(note);
          }catch{}
          function inferStrategyPreference(){
            try{
              const raw = localStorage.getItem('glowup:metrics');
              const store = raw? JSON.parse(raw):{};
              const events = Array.isArray(store?.events)? store.events: [];
              const recent = events.slice(-300);
              const searches = recent.filter(e=> e.type==='search');
              const adoptions = recent.filter(e=> e.type==='adoption');
              if(!searches.length || !adoptions.length) return { fast:false, habit:false };
              const adTimes = adoptions.map(e=> new Date(e.t).getTime()).sort((a,b)=> a-b);
              const deltas = [];
              for(const s of searches){ const st=new Date(s.t).getTime(); const a=adTimes.find(t=> t>=st); if(a){ deltas.push(a-st); } }
              if(!deltas.length) return { fast:false, habit:false };
              const median = deltas.sort((a,b)=> a-b)[Math.floor(deltas.length/2)];
              const oneDay = 24*60*60*1000;
              const fastPref = median <= oneDay;
              const qTokens = searches.map(s=> String(s.query||'').toLowerCase());
              const fastWords = qTokens.filter(q=> /短期|即|早|最短|プラン/.test(q)).length;
              const habitWords = qTokens.filter(q=> /習慣|続け|ルーティン|週次|継続/.test(q)).length;
              const habitPref = (!fastPref && habitWords>fastWords) || (median>oneDay);
              return { fast: fastPref, habit: habitPref };
            }catch{ return { fast:false, habit:false }; }
          }
          function strategyWeight(lab){
            const s = Number(axes.support)||0, c = Number(axes.change)||0, m = Number(axes.motivation)||0, ctrl = Number(axes.control)||0;
            const pref = inferStrategyPreference(); const L=String(lab); let w=0;
            if(/即効|小さな変更|写真|比較|スプリント/.test(L)) w += (pref.fast? 3: 0) + c*2 + m;
            if(/習慣|ルール化|定期|振り返り|チェックイン/.test(L)) w += (pref.habit? 3: 0) + s*2 + m;
            if(/目的|評価指標|明文化/.test(L)) w += m*2 + ctrl;
            if(/透明性|意思決定|比較検討/.test(L)) w += ctrl*2 + m;
            return w;
          }
          const candidates = [
            '即効性のある小さな変更を試す（写真や比較で検証）',
            '短いスプリントで試す（1〜2週間）',
            '時間をかけて習慣化する（ルール化/定期振り返り）',
            '定期チェックインを設ける（相談/確認）',
            '目的を明文化し評価指標を決める',
            '意思決定の透明性を確保し、比較検討する'
          ];
          const strat = candidates.slice().sort((a,b)=> strategyWeight(b) - strategyWeight(a)).slice(0,4);
          const sH = document.createElement('h4'); sH.textContent='進め方'; wrap.appendChild(sH);
          const stratWeights = strat.map(x=> strategyWeight(x));
          const stratSpread = (stratWeights.length? (Math.max(...stratWeights)-Math.min(...stratWeights)): 0);
          const pref = inferStrategyPreference();
          const showStratRanks = stratSpread > 0.5 && ((pref.s||0) > 2 || (pref.a||0) > 1);
          const stratUl = document.createElement('ul'); strat.forEach((t,i)=>{ const li=document.createElement('li'); li.textContent=t; if(showStratRanks){ const b=document.createElement('span'); b.textContent=` 優先度 ${i+1}`; b.style.marginLeft='6px'; b.style.padding='2px 6px'; b.style.border='1px solid var(--color-border)'; b.style.borderRadius='999px'; b.style.fontSize='12px'; li.appendChild(b); } stratUl.appendChild(li); }); wrap.appendChild(stratUl);
          if(!showStratRanks){ const note=document.createElement('p'); note.className='muted'; note.textContent='※ 行動データが少ないため、進め方の順位付けは行っていません（同程度）。'; wrap.appendChild(note); }
          card.appendChild(wrap);
        })();
        const link = document.createElement('a'); link.className='btn';
        const q = typeName ? `?keyword=${encodeURIComponent(typeName)}` : '';
        link.href = `/pages/search.html${q}`; link.textContent='このタイプに合う人を見てみる';
        try{ link.style.setProperty('color','#111','important'); }catch{}
        card.appendChild(link);
        host.appendChild(card);
      }).catch(()=>{});
    }catch(e){ emptyState(); }
  })();
  </script>
</body>
</html>
