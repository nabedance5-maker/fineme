<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fineme - è¦‹ãŸç›®è¨ºæ–­</title>
  <link rel="stylesheet" href="/assets/styles/style.css">
  <style>
    .diag-container{max-width:900px;margin:36px auto;padding:20px}
    .diag-card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.06)}
    .diag-q{font-weight:700;margin-bottom:12px}
  .diag-input{display:flex;gap:8px;justify-content:flex-start}
  /* only style text-like inputs; don't apply flex to radios */
  .diag-input input[type="text"], .diag-input input[type="search"], .diag-input textarea{flex:1;padding:10px;border-radius:8px;border:1px solid #e5e7eb}
  /* ensure radio/option labels are left-aligned */
  .diag-input label{display:flex;align-items:center;gap:10px;justify-content:flex-start;width:100%}
  .diag-input label span{display:inline-block;text-align:left}
    .diag-result{margin-top:16px}
    .result-title{font-size:22px;font-weight:800}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <header id="site-header">
    <!-- inlined header for static demo to avoid relying on runtime injection -->
    <link rel="icon" href="/favicon.ico">
    <style>
      .navbar .brand { white-space:nowrap; font-weight:700; font-size:clamp(16px,2.2vw,20px); }
      .nav-links { display:flex; gap:8px; align-items:center; overflow-x:auto; }
      .nav-links a { display:inline-block !important; white-space:nowrap !important; }
      .header-actions { display:inline-flex; align-items:center; gap:8px; }
      @media (min-width:1025px) { .nav-links > a:first-of-type { margin-left:auto !important; } }
    </style>
    <div class="navbar">
      <div class="container navbar-inner">
        <a class="brand logo" href="/">Fineme</a>
        <button class="nav-toggle" id="nav-toggle" aria-expanded="false" aria-controls="nav-menu" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â˜°</button>
        <div class="nav-group" id="nav-menu">
          <nav class="nav-links">
            <a href="/pages/search.html">æ¤œç´¢</a>
            <a href="/pages/about.html">ç§ãŸã¡ã«ã¤ã„ã¦</a>
            <a href="/pages/feature.html">ç‰¹é›†</a>
            <div class="header-actions">
              <div id="header-notifs" style="position:relative">
                <button id="header-notifs-btn" class="btn btn-ghost" type="button" aria-label="é€šçŸ¥">ğŸ”” <span id="header-notifs-badge" style="display:inline-block;min-width:18px;padding:2px 6px;border-radius:999px;background:#ef4444;color:#fff;font-size:12px;margin-left:6px;" hidden>0</span></button>
                <div id="header-notifs-dropdown" style="position:absolute;right:0;top:36px;min-width:280px;background:#fff;border:1px solid #eee;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06);display:none;z-index:1200;padding:8px">
                  <div id="header-notifs-list" style="max-height:240px;overflow:auto"></div>
                  <div style="text-align:right;margin-top:8px"><button id="header-notifs-clear" class="btn btn-ghost">ã™ã¹ã¦æ—¢èª­</button></div>
                </div>
              </div>
              <a id="header-diagnosis-btn" class="btn" href="/diagnosis/index.html">è¨ºæ–­ã™ã‚‹</a>
              <span id="header-auth-area"><a id="header-login-link" href="/pages/user/login.html">ãƒ­ã‚°ã‚¤ãƒ³</a></span>
            </div>
          </nav>
        </div>
      </div>
    </div>
  </header>
  <main>
    <div class="diag-container">
      <div class="diag-card">
        <h1>è¦‹ãŸç›®è¨ºæ–­</h1>
        <p class="muted">æ€§åˆ¥ã‚’é¸æŠã—ã¦ã€å…¨16å•ã«ãŠç­”ãˆãã ã•ã„ã€‚è¨ºæ–­çµæœã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        <div id="chat-root">
          <div id="progress" style="height:10px;background:#eef2ff;border-radius:6px;margin-bottom:12px;overflow:hidden"><div id="progress-bar" style="height:100%;background:linear-gradient(90deg,#6d28d9,#2563eb);width:0%"></div></div>
          <div id="step-meta" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div id="step-label">æº–å‚™</div><div id="step-count" class="muted">0 / 16</div></div>
          <div id="question" class="diag-q">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
          <div id="controls" class="diag-input">
            <!-- dynamic controls (radio buttons) will be rendered here -->
          </div>
          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <button id="prevBtn" class="btn btn-ghost" disabled>æˆ»ã‚‹</button>
            <button id="nextBtn" class="btn">æ¬¡ã¸</button>
          </div>
        </div>
        <div id="result" class="diag-result" hidden></div>
      </div>
    </div>
  </main>
  <footer id="site-footer"></footer>
  <script>
    // New diagnosis logic per spec
    const QUESTIONS_URL = '/data/questions.json';
    const TYPES_URL = '/data/types.json';
    const STORAGE_KEY = 'fineme:diagnosis:latest';

    let questionsFlat = []; // ordered array of {axis, id, question, options[2]}
    let answers = {}; // index -> selected option index (0 or 1)
    let gender = null;
    let current = 0;

    const qEl = document.getElementById('question');
    const ctrl = document.getElementById('controls');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const progressBar = document.getElementById('progress-bar');
    const stepLabel = document.getElementById('step-label');
    const stepCount = document.getElementById('step-count');

    function setProgress(){
      const pct = Math.round((current / (questionsFlat.length)) * 100);
      progressBar.style.width = pct + '%';
      stepCount.textContent = (Math.min(current+1, questionsFlat.length)) + ' / ' + questionsFlat.length;
    }

    function renderGenderSelection(){
      qEl.textContent = 'æ€§åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„';
      ctrl.innerHTML = '';
      const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='12px';
      ['male','female'].forEach(g=>{
        const btn = document.createElement('button'); btn.type='button'; btn.className='btn'; btn.textContent = g === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
        btn.addEventListener('click', ()=>{ gender = g; answers = {}; current = 0; renderQuestion(); });
        wrap.appendChild(btn);
      });
      ctrl.appendChild(wrap);
      prevBtn.disabled = true; nextBtn.disabled = true; stepLabel.textContent = 'æ€§åˆ¥é¸æŠ'; stepCount.textContent = '0 / 16'; progressBar.style.width='0%';
    }

    function renderQuestion(){
      if(!gender){ renderGenderSelection(); return; }
      if(questionsFlat.length === 0){ qEl.textContent = 'è³ªå•ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'; ctrl.innerHTML=''; nextBtn.disabled=true; return; }
      // show current question
  const q = questionsFlat[current];
  qEl.textContent = q.question || 'è³ªå•æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
      ctrl.innerHTML = '';
      const list = document.createElement('div'); list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='8px';
      q.options = q.options || ['A','B'];
      q.options.forEach((opt, i)=>{
        const id = `opt_${current}_${i}`;
        const label = document.createElement('label'); label.style.display='flex'; label.style.alignItems='center'; label.style.gap='10px';
        const radio = document.createElement('input'); radio.type='radio'; radio.name='diag_opt'; radio.id=id; radio.value=i;
        if(answers[current] === i) radio.checked = true;
        radio.addEventListener('change', ()=>{ answers[current] = i; nextBtn.disabled = false; });
        const span = document.createElement('span'); span.textContent = opt;
        label.appendChild(radio); label.appendChild(span); list.appendChild(label);
      });
      ctrl.appendChild(list);
      prevBtn.disabled = current === 0;
      nextBtn.disabled = answers[current] === undefined;
      nextBtn.textContent = current < questionsFlat.length-1 ? 'æ¬¡ã¸' : 'è¨ºæ–­ã™ã‚‹';
      setProgress();
      stepLabel.textContent = q.axis || '';
    }

    prevBtn.addEventListener('click', ()=>{ if(current>0){ current--; renderQuestion(); }});

    nextBtn.addEventListener('click', ()=>{
      if(!gender){ return; }
      if(answers[current] === undefined) return;
      if(current < questionsFlat.length-1){ current++; renderQuestion(); return; }
      // compute per-axis scores
      const axisMap = { 'Soft-Hard': {left:'Soft',right:'Hard'}, 'Simple-Glam':{left:'Simple',right:'Glam'}, 'Calm-Bright':{left:'Calm',right:'Bright'}, 'Natural-Mode':{left:'Natural',right:'Mode'} };
      const axisScores = { 'Soft-Hard':0,'Simple-Glam':0,'Calm-Bright':0,'Natural-Mode':0 };
      // questionsFlat contains questions in axis order; assume each axis has 4 questions
      questionsFlat.forEach((q, idx)=>{
        const sel = answers[idx]; if(sel === undefined) return;
        // assume option index 1 indicates right-side
        if(sel === 1) axisScores[q.axis] = (axisScores[q.axis] || 0) + 1;
      });
      // determine direction per axis
      const directions = {};
      Object.keys(axisScores).forEach(ax=>{ const v = axisScores[ax]||0; directions[ax] = (v >=3) ? axisMap[ax].right : axisMap[ax].left; });
      // build bitmask: Soft-Hard (msb), Simple-Glam, Calm-Bright, Natural-Mode (lsb)
      const bits = [ directions['Soft-Hard'].startsWith('Hard') ? 1:0, directions['Simple-Glam'].startsWith('Glam')?1:0, directions['Calm-Bright'].startsWith('Bright')?1:0, directions['Natural-Mode'].startsWith('Mode')?1:0 ];
      const val = (bits[0]<<3) | (bits[1]<<2) | (bits[2]<<1) | (bits[3]<<0);
      const typeId = 't' + String(val+1).padStart(2,'0');
      const resultObj = { at: Date.now(), gender, type_id: typeId, directions, axisScores, answers };
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(resultObj)); }catch(e){ console.warn('localStorage set failed', e); }
      window.location.href = 'result.html';
    });

    // load questions.json and initialize questionsFlat
    fetch(QUESTIONS_URL).then(r=>r.json()).then(data=>{
      // expected structure: { "Soft-Hard": [...], "Simple-Glam": [...], ... }
      const axes = ['Soft-Hard','Simple-Glam','Calm-Bright','Natural-Mode'];
      axes.forEach(ax=>{
        const qlist = (data && data[ax]) ? data[ax] : [];
        // ensure exactly 4 questions per axis; if missing, fill placeholders
        for(let i=0;i<4;i++){
    const q = qlist[i] || { id: `${ax}_${i+1}`, question: `${ax} ã«é–¢ã™ã‚‹è³ªå•${i+1}`, options: ['å·¦ã®ç‰¹å¾´ã«è¿‘ã„','å³ã®ç‰¹å¾´ã«è¿‘ã„'] };
    questionsFlat.push({ axis: ax, id: q.id || `${ax}_${i+1}`, question: q.question || `${ax} ã®è³ªå•${i+1}`, options: q.options || ['å·¦ã®ç‰¹å¾´ã«è¿‘ã„','å³ã®ç‰¹å¾´ã«è¿‘ã„'] });
        }
      });
      // initialize UI
      renderGenderSelection();
    }).catch(err=>{
      console.error('questions load error', err);
      // fallback: generate 16 placeholder questions
      const axes = ['Soft-Hard','Simple-Glam','Calm-Bright','Natural-Mode'];
  axes.forEach(ax=>{ for(let i=0;i<4;i++) questionsFlat.push({ axis:ax, id:`${ax}_${i+1}`, question:`${ax} ã«é–¢ã™ã‚‹è³ªå•${i+1}`, options:['å·¦ã®ç‰¹å¾´ã«è¿‘ã„','å³ã®ç‰¹å¾´ã«è¿‘ã„'] }); });
      renderGenderSelection();
    });
  </script>
</body>
</html>
